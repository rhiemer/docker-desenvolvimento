ARG IMAGEM_BASE="sefaz/eclipseap6"

FROM $IMAGEM_BASE

USER root

ARG JBOSS_NAME="jboss"
ENV JBOSS_NAME "$JBOSS_NAME"

ARG USER_JBOSS="jboss"
ENV USER_JBOSS "$USER_JBOSS"
ARG FOLDER_ROOT="/opt"
ENV FOLDER_ROOT "$FOLDER_ROOT"
ARG FOLDER_SCRIPTS_ROOT="/var"
ENV FOLDER_SCRIPTS_ROOT "$FOLDER_SCRIPTS_ROOT"
ARG FOLDER_SCRIPTS_ROOT_SCRIPTS="$FOLDER_SCRIPTS_ROOT/scripts"
ENV FOLDER_SCRIPTS_ROOT_SCRIPTS "$FOLDER_SCRIPTS_ROOT_SCRIPTS"
ARG FOLDER_APP="$FOLDER_ROOT/app"
ENV FOLDER_APP "$FOLDER_APP"
ARG JBOSS_HOME="$FOLDER_APP/jboss"
ENV JBOSS_HOME "$JBOSS_HOME"

ENV FOLDER_DOCKER_INSTALL "$FOLDER_ROOT/install"
ENV FOLDER_DOCKER_INSTALL_ARQUIVOS "$FOLDER_DOCKER_INSTALL/arquivos"
ENV FOLDER_DOCKER_INSTALL_BIN "$FOLDER_DOCKER_INSTALL/bin"
ENV FOLDER_DOCKER_INSTALL_BIN_JBOSS "$FOLDER_DOCKER_INSTALL_BIN/jboss"
ENV FOLDER_DOCKER_INSTALACAO_HOST "docker/instalacao"
ENV FOLDER_DOCKER_INSTALACAO "$FOLDER_DOCKER_INSTALL_ARQUIVOS/docker/instalacao"
ENV DOCKER_INSTALACAO_JBOSS_FOLDER "$FOLDER_DOCKER_INSTALACAO/jboss"
ENV DOCKER_INSTALACAO_JBOSS_FOLDER_HOST "$FOLDER_DOCKER_INSTALACAO_HOST/jboss"

ARG PASTA_VAZIA="pasta_vazia"
ENV PASTA_VAZIA "$PASTA_VAZIA"
ARG PASTA_VAZIA_COPY="$PASTA_VAZIA/."
ENV PASTA_VAZIA_COPY="$PASTA_VAZIA_COPY"

RUN mkdir -pv $DOCKER_INSTALACAO_JBOSS_FOLDER
WORKDIR $DOCKER_INSTALACAO_JBOSS_FOLDER/

RUN mkdir -pv $FOLDER_DOCKER_INSTALL_BIN
ARG URL_DOWNLOADS_BIN=""
ENV URL_DOWNLOADS_BIN "$URL_DOWNLOADS_BIN"
COPY $DOCKER_INSTALACAO_JBOSS_FOLDER_HOST/download-bin.sh $DOCKER_INSTALACAO_JBOSS_FOLDER/
RUN find $DOCKER_INSTALACAO_JBOSS_FOLDER/download-bin.sh -type f  \      
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \    
      -exec chmod +x {} \; \
      -exec chown -R $USER_JBOSS:$USER_JBOSS {} \; \
      -exec {} \;
      
ARG FILE_INSTALL_JBOSS_ZIP=""
ENV FILE_INSTALL_JBOSS_ZIP "$FILE_INSTALL_JBOSS_ZIP"
ARG PATCH_APPLY=""
ENV PATCH_APPLY "$PATCH_APPLY"
ARG FOLDER_BIN="$PASTA_VAZIA_COPY"
ENV FOLDER_BIN "$FOLDER_BIN"
ARG FOLDER_BIN_FILTER="/*"
ENV FOLDER_BIN_FILTER "$FOLDER_BIN_FILTER"
ARG SOURCE_BIN="$FOLDER_BIN$FOLDER_BIN_FILTER"
ENV SOURCE_BIN "$SOURCE_BIN"
ARG FOLDER_INSTALL_JBOSS_ZIP="*/."
ENV FOLDER_INSTALL_JBOSS_ZIP "$FOLDER_INSTALL_JBOSS_ZIP"
ARG FOLDER_INSTALL_JBOSS_ZIP_CP="."
ENV FOLDER_INSTALL_JBOSS_ZIP_CP "$FOLDER_INSTALL_JBOSS_ZIP_CP"
COPY $SOURCE_BIN $FOLDER_DOCKER_INSTALL_BIN/
RUN find $FOLDER_DOCKER_INSTALL_BIN -type f  \      
      -exec echo {} \; \      
      -exec chown -R $USER_JBOSS:$USER_JBOSS {} \; 

RUN  mkdir -pv $JBOSS_HOME \
  && chown -R $USER_JBOSS:$USER_JBOSS $JBOSS_HOME

COPY $DOCKER_INSTALACAO_JBOSS_FOLDER_HOST/instalar-jboss-binarios.sh $DOCKER_INSTALACAO_JBOSS_FOLDER/
RUN find $DOCKER_INSTALACAO_JBOSS_FOLDER/instalar-jboss-binarios.sh -type f  \      
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \    
      -exec chmod +x {} \; \
      -exec chown -R $USER_JBOSS:$USER_JBOSS {} \; \
      -exec {} \;

ARG JBOSS_HOME_BIN="$JBOSS_HOME/bin"
ENV JBOSS_HOME_BIN "$JBOSS_HOME_BIN"
ARG JBOSS_CLI="./jboss-cli.sh"
ENV JBOSS_CLI "$JBOSS_CLI"
ARG JBOSS_CLI_COMMAND_PATCH="patch apply"
ENV JBOSS_CLI_COMMAND_PATCH "$JBOSS_CLI_COMMAND_PATCH"
COPY $DOCKER_INSTALACAO_JBOSS_FOLDER_HOST/instalar-jboss-patches.sh $DOCKER_INSTALACAO_JBOSS_FOLDER/
RUN find $DOCKER_INSTALACAO_JBOSS_FOLDER/instalar-jboss-patches.sh -type f  \
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \    
      -exec chmod +x {} \; \
      -exec chown -R $USER_JBOSS:$USER_JBOSS {} \; \
      -exec {} \;

ENV FOLDER_DOCKER_INSTALL_CONFIGURACAO "$FOLDER_DOCKER_INSTALL_ARQUIVOS/configuracao"
ENV FOLDER_DOCKER_INSTALL_CONFIGURACAO_JBOSS "$FOLDER_DOCKER_INSTALL_CONFIGURACAO/jboss"
ARG FOLDER_CONFIGURACAO="$PASTA_VAZIA_COPY"
ENV FOLDER_CONFIGURACAO "$FOLDER_CONFIGURACAO"
COPY $FOLDER_CONFIGURACAO $FOLDER_DOCKER_INSTALL_CONFIGURACAO_JBOSS/
RUN echo "Arquivos de configuração do jboss" \ 
    && find $FOLDER_DOCKER_INSTALL_CONFIGURACAO_JBOSS -type f  \
      -exec echo {} \; \
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \    
    && find $FOLDER_DOCKER_INSTALL_CONFIGURACAO_JBOSS -type f -iname "*.sh" -exec chmod +x {} \; \
    && chown -R $USER_JBOSS:$USER_JBOSS $FOLDER_DOCKER_INSTALL_CONFIGURACAO_JBOSS

ARG SUBFOLDER_CONFIGURACAO=""
ENV SUBFOLDER_CONFIGURACAO "$SUBFOLDER_CONFIGURACAO"
COPY $DOCKER_INSTALACAO_JBOSS_FOLDER_HOST/configurar.sh $DOCKER_INSTALACAO_JBOSS_FOLDER/
RUN find $DOCKER_INSTALACAO_JBOSS_FOLDER/configurar.sh -type f  \      
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \    
      -exec chmod +x {} \; \
      -exec chown -R $USER_JBOSS:$USER_JBOSS {} \; \
      -exec {} \;
      

ENV FOLDER_SCRIPTS_JBOSS_INSTALL "$FOLDER_DOCKER_INSTALL_ARQUIVOS/scripts-jboss"
ARG FOLDER_SCRIPTS_JBOSS_HOST="$PASTA_VAZIA_COPY"
ENV FOLDER_SCRIPTS_JBOSS_HOST "$FOLDER_SCRIPTS_JBOSS_HOST"
COPY $FOLDER_SCRIPTS_JBOSS_HOST $FOLDER_SCRIPTS_JBOSS_INSTALL/
RUN echo "Scripts do jboss" \ 
    && find $FOLDER_SCRIPTS_JBOSS_INSTALL -type f  \
      -exec echo {} \; \
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \    
    && find $FOLDER_SCRIPTS_JBOSS_INSTALL -type f -iname "*.sh" -exec chmod +x {} \; \
    && chown -R $USER_JBOSS:$USER_JBOSS $FOLDER_SCRIPTS_JBOSS_INSTALL

ARG FOLDER_SCRIPTS_ROOT_SCRIPTS="$FOLDER_SCRIPTS_ROOT/scripts"
ENV FOLDER_SCRIPTS_ROOT_SCRIPTS "$FOLDER_SCRIPTS_ROOT_SCRIPTS"    
ARG FOLDER_SCRIPTS_JBOSS="$FOLDER_SCRIPTS_ROOT_SCRIPTS/jboss"
ENV FOLDER_SCRIPTS_JBOSS "$FOLDER_SCRIPTS_JBOSS"
RUN mkdir -pv $FOLDER_SCRIPTS_JBOSS \
    && chown -R $USER_JBOSS:$USER_JBOSS $FOLDER_SCRIPTS_JBOSS     

ARG SUBFOLDER_SCRIPTS_JBOSS=""
ENV SUBFOLDER_SCRIPTS_JBOSS "$SUBFOLDER_SCRIPTS_JBOSS"
COPY $DOCKER_INSTALACAO_JBOSS_FOLDER_HOST/configurar-scripts.sh $DOCKER_INSTALACAO_JBOSS_FOLDER/
RUN find $DOCKER_INSTALACAO_JBOSS_FOLDER/configurar-scripts.sh -type f  \ 
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \    
      -exec chmod +x {} \; \
      -exec chown -R $USER_JBOSS:$USER_JBOSS {} \; \
      -exec {} \;     

ARG FOLDER_DOCKER_INSTALACAO_CUSTOMIZACAO_HOST="$FOLDER_DOCKER_INSTALACAO_HOST/customizacao"
ENV FOLDER_DOCKER_INSTALACAO_CUSTOMIZACAO_HOST "$FOLDER_DOCKER_INSTALACAO_CUSTOMIZACAO_HOST"
ENV FOLDER_DOCKER_INSTALACAO_CUSTOMIZACAO "$FOLDER_DOCKER_INSTALACAO/customizacao"
COPY $FOLDER_DOCKER_INSTALACAO_CUSTOMIZACAO_HOST $FOLDER_DOCKER_INSTALACAO_CUSTOMIZACAO/
RUN echo "Arquivos de customização do jboss" \ 
    && find $FOLDER_DOCKER_INSTALACAO_CUSTOMIZACAO -type f  \
      -exec echo {} \; \
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \    
    && find $FOLDER_DOCKER_INSTALACAO_CUSTOMIZACAO -type f -iname "*.sh" -exec chmod +x {} \; \
    && chown -R $USER_JBOSS:$USER_JBOSS $FOLDER_DOCKER_INSTALACAO_CUSTOMIZACAO
    

ARG START_SH_FOLDER="$JBOSS_HOME"
ENV START_SH_FOLDER "$START_SH_FOLDER"
ARG START_SH=""
ENV START_SH "$START_SH"
ARG START_SH_FULL="$START_SH_FOLDER/$START_SH"
ENV START_SH_FULL "$START_SH_FULL"
ARG JBOSS_CONSOLE_LOG_FILE="$JBOSS_CONSOLE_LOG_FILE"
ENV JBOSS_CONSOLE_LOG_FILE "$JBOSS_CONSOLE_LOG_FILE"
ARG JBOSS_CONSOLE_LOG="${JBOSS_CONSOLE_LOG:-${JBOSS_CONSOLE_LOG_FILE:+$JBOSS_HOME/$JBOSS_CONSOLE_LOG_FILE}}"
ENV JBOSS_CONSOLE_LOG "$JBOSS_CONSOLE_LOG"
ARG CODIGO_JBOSS_SUCESSO="JBAS015874:\|WFLYSRV0025:"
ENV CODIGO_JBOSS_SUCESSO "$CODIGO_JBOSS_SUCESSO"
ARG CODIGO_JBOSS_ERRO="JBAS014777:\|WFLYSRV0026:\|WFLYSRV0050:"
ENV CODIGO_JBOSS_ERRO "$CODIGO_JBOSS_ERRO"
ARG SUBFOLDER_CUSTOMIZACAO=""
ENV SUBFOLDER_CUSTOMIZACAO "$SUBFOLDER_CUSTOMIZACAO"
ARG VARIAVEIS_CUSTOMIZACAO=""
ENV VARIAVEIS_CUSTOMIZACAO "$VARIAVEIS_CUSTOMIZACAO"
COPY $DOCKER_INSTALACAO_JBOSS_FOLDER_HOST/customizar.sh $DOCKER_INSTALACAO_JBOSS_FOLDER/
RUN find $DOCKER_INSTALACAO_JBOSS_FOLDER/customizar.sh -type f  \      
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \    
      -exec chmod +x {} \; \
      -exec chown -R $USER_JBOSS:$USER_JBOSS {} \; \
      -exec {} +
      
ARG DOCKER_ENTRYPOINT=""
ENV DOCKER_ENTRYPOINT="$DOCKER_ENTRYPOINT"
ARG DOCKER_RUN_JBOSS_FOLDER_HOST="docker/run"
ENV DOCKER_RUN_JBOSS_FOLDER_HOST="$DOCKER_RUN_JBOSS_FOLDER_HOST"
ARG DOCKER_RUN_JBOSS_HOST="$DOCKER_RUN_JBOSS_FOLDER_HOST/."
ENV DOCKER_RUN_JBOSS_HOST="$DOCKER_RUN_JBOSS_HOST"
ARG FOLDER_SCRIPT_ENTRY_POINT="$FOLDER_SCRIPTS_ROOT/entryPoint"
ENV FOLDER_SCRIPT_ENTRY_POINT="$FOLDER_SCRIPT_ENTRY_POINT"
COPY $DOCKER_RUN_JBOSS_HOST $FOLDER_SCRIPT_ENTRY_POINT/
RUN find $FOLDER_SCRIPT_ENTRY_POINT -type f  \
      -exec echo {} \; \ 
      -exec sh -c 'tr -d "\r" < "{}" > "{}".new && mv "{}".new "{}"' -- {} \; \
      -exec chmod +x {} \; \
      -exec chown -R $USER_JBOSS:$USER_JBOSS {} \;

RUN rm -rf $FOLDER_DOCKER_INSTALL

USER $USER_JBOSS

ARG EXPOSE="8080"
ENV EXPOSE "$EXPOSE"
EXPOSE $EXPOSE

ARG WORKDIR_START="$JBOSS_HOME/"
ENV WORKDIR_START "$WORKDIR_START"
WORKDIR $WORKDIR_START

ARG LAUNCH_JBOSS_IN_BACKGROUND=true
ENV LAUNCH_JBOSS_IN_BACKGROUND="$LAUNCH_JBOSS_IN_BACKGROUND"
ARG DOCKER_ENTRY_POINT_FILE=""
ENV DOCKER_ENTRY_POINT_FILE="$DOCKER_ENTRY_POINT_FILE"
ARG DOCKER_ENTRYPOINT=""
ENV DOCKER_ENTRYPOINT="$DOCKER_ENTRYPOINT"
ARG DOCKER_ENTRY_POINT_PARAMS=""
ENV DOCKER_ENTRY_POINT_PARAMS="$DOCKER_ENTRY_POINT_PARAMS"